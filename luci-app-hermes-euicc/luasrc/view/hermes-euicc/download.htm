<%+header%>

<!-- eSIM Connectivity Banner -->
<div id="esim-connectivity-banner" class="mb-20">
    <div id="connectivity-checking" class="info-box">
        <i class="icon-spinner"></i> <strong><%:Checking internet connection...%></strong>
    </div>

    <div id="connectivity-online" class="success-box">
        <i class="icon-ok"></i> <strong><%:Internet connection available%></strong> - <%:You can manage eSIM profiles%>
    </div>

    <div id="connectivity-offline" class="error-box">
        <i class="icon-remove"></i> <strong><%:No internet connection detected%></strong> - <%:An internet connection is required to download and manage eSIM profiles. Please check your WAN connection.%>
        <br><br>
        <button type="button" class="cbi-button cbi-button-apply" onclick="checkConnectivity()"><%:Check Again%></button>
    </div>
</div>

<h2 name="content"><%:Download Profile%></h2>
<div class="cbi-map-descr"><%:Download a new eSIM profile using QR code, activation code, or SM-DS discovery%></div>

<!-- SM-DS Quick Download Section -->
<fieldset class="cbi-section">
    <legend><%:Quick Download from SM-DS%></legend>
    <div class="cbi-section-node">
        <p class="quick-download-description">
            <%:No activation code? Let us automatically discover and download available profiles from SM-DS!%>
        </p>

        <div class="cbi-value">
            <label class="cbi-value-title"><%:SM-DS Server%> (<%:optional%>):</label>
            <div class="cbi-value-field">
                <input type="text" id="smds-server" class="cbi-input-text" placeholder="prod.smds.rsp.goog">
                <div class="file-help">
                    <%:Leave empty to use default GSMA SM-DS server%>
                </div>
            </div>
        </div>

        <div class="cbi-value">
            <label class="cbi-value-title"><%:IMEI%> (<%:optional%>):</label>
            <div class="cbi-value-field">
                <input type="text" id="smds-imei" class="cbi-input-text" placeholder="123456789012345">
                <div class="file-help">
                    <%:Required for some operators%>
                </div>
            </div>
        </div>

        <div class="cbi-value">
            <label class="cbi-value-title"></label>
            <div class="cbi-value-field">
                <input type="button" class="cbi-button cbi-button-apply" value="<%:Discover & Download%>" onclick="discoverAndDownload()" />
            </div>
        </div>

        <div id="discover-download-loading" class="status-message-loading">
            <img src="<%=resource%>/hermes-euicc/icons/loading.gif" alt="Loading" class="v-align-middle" />
            <%:Searching for profiles and downloading...%>
        </div>

        <div id="discover-download-success" class="status-message-success">
            <i class="icon-ok"></i> <strong><%:Success%>:</strong> <span id="discover-download-success-message"></span>
        </div>

        <div id="discover-download-error" class="status-message-error">
            <i class="icon-remove"></i> <strong><%:Error%>:</strong> <span id="discover-download-error-message"></span>
        </div>

        <div id="discover-download-info" class="status-message-info">
            <i class="icon-info"></i> <strong><%:Info%>:</strong> <span id="discover-download-info-message"></span>
        </div>
    </div>
</fieldset>

<div class="divider">
    ━━━ <%:OR%> ━━━
</div>

<fieldset class="cbi-section">
    <legend><%:QR Code Upload%></legend>
    <div class="cbi-section-node">
        <div class="cbi-value">
            <label class="cbi-value-title"><%:QR Code Image%>:</label>
            <div class="cbi-value-field">
                <input type="file" id="qr-file" accept="image/*" onchange="handleQRFile(this)" class="cbi-input-file" />
                <div class="file-help"><%:Upload a JPG or PNG image containing the QR code - it will be decoded automatically%></div>
            </div>
        </div>
        
        <div id="qr-preview-container" class="hidden mt-15">
            <div class="cbi-value">
                <label class="cbi-value-title"><%:Preview%>:</label>
                <div class="cbi-value-field">
                    <div class="inline-block v-align-top">
                        <img id="qr-preview" class="img-preview" />

                        <div id="qr-decode-status" class="mt-8 min-height-20">
                            <div id="qr-decode-loading" class="qr-decode-loading">
                                <i class="icon-spinner"></i> <%:Decoding QR code...%>
                            </div>
                            <div id="qr-decode-success" class="qr-decode-success">
                                <strong><%:QR Code decoded successfully!%></strong>
                            </div>
                            <div id="qr-decode-error" class="qr-decode-error">
                                <strong><%:Error%>:</strong> <span id="qr-decode-error-message"></span>
                            </div>
                        </div>

                        <button type="button" class="qr-clear-btn mt-10" onclick="clearQRUpload()"><%:Clear%></button>
                    </div>
                </div>
            </div>
        </div>

        <div id="qr-activation-code-container" class="hidden mt-15">
            <div class="cbi-value">
                <label class="cbi-value-title"><%:QR Activation Code%>:</label>
                <div class="cbi-value-field">
                    <input type="text" id="qr-activation-code" class="cbi-input-text">
                </div>
            </div>
        </div>
</fieldset>

<fieldset class="cbi-section">
    <legend><%:Manual Download%></legend>
    <div class="cbi-section-node">
        <div class="cbi-value">
            <label class="cbi-value-title"><%:SM-DP+ Server Address%>:</label>
            <div class="cbi-value-field">
                <input type="text" id="smdp-server-address" class="cbi-input-text" placeholder="<%:Enter SM-DP+ server address%>">
            </div>
        </div>

        <div class="cbi-value">
            <label class="cbi-value-title"><%:Activation Code%>:</label>
            <div class="cbi-value-field">
                <input type="text" id="activation-code" class="cbi-input-text" placeholder="<%:Enter Activation Code%>">
            </div>
        </div>

        <div class="cbi-value">
            <label class="cbi-value-title"><%:Confirmation Code%>:</label>
            <div class="cbi-value-field">
                <input type="text" id="confirmation-code" class="cbi-input-text" placeholder="<%:Optional Confirmation Code%>">
            </div>
        </div>
    </div>
</fieldset>

<div id="download-status" class="download-status">
    <div id="download-loading" class="loading-container hidden">
        <img src="<%=resource%>/icons/loading.gif" alt="<%:Loading%>" class="v-align-middle" />
        <%:Downloading profile...%>
    </div>

    <div id="download-success" class="success-box">
        <strong><%:Success%>:</strong> <span id="download-success-message"></span>
    </div>

    <div id="download-error" class="error-box">
        <strong><%:Error%>:</strong> <span id="download-error-message"></span>
    </div>
</div>

<!-- Output Logs Section - will be created dynamically by JavaScript -->
<div id="output-logs-section" class="mt-30 hidden">
    <fieldset class="cbi-section">
        <legend><%:Output Logs%></legend>
        <div class="cbi-section-node">
            <div id="output-logs-content" class="logs-content">
                <!-- Logs will appear here -->
            </div>
        </div>
    </fieldset>
</div>

<div class="cbi-page-custom-actions">
    <input type="button" class="cbi-button cbi-button-save process-btn" value="<%:Download Profile%>" onclick="downloadProfile()" />
    <input type="button" class="cbi-button cbi-button-reset remove-btn" value="<%:Clear All%>" onclick="clearForm()" />
    <input type="button" class="cbi-button cbi-button-reset refresh-btn" value="<%:Clear Logs%>" onclick="clearDownloadLogs()" />
</div>

<link rel="stylesheet" type="text/css" href="<%=resource%>/hermes-euicc/css/hermes-euicc.css" />
<script type="text/javascript" src="<%=resource%>/hermes-euicc/js/hermes-connectivity.js"></script>
<script type="text/javascript" src="<%=resource%>/hermes-euicc/js/hermes-download.js"></script>
<script type="text/javascript" src="<%=resource%>/hermes-euicc/js/jsQR.js"></script>
<script type="text/javascript">
    // Download page doesn't need auto-initialization
    // All functions are triggered by user actions
</script>

<%+footer%>